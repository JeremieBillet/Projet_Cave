package com.intiformation.projet.caveavin.dao;

import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

import com.intiformation.projet.caveavin.modele.Alcool;
import com.intiformation.projet.caveavin.modele.Biere;
import com.intiformation.projet.caveavin.modele.CatCepage;
import com.intiformation.projet.caveavin.modele.CatPays;
import com.intiformation.projet.caveavin.modele.CatRegion;
import com.intiformation.projet.caveavin.modele.CatType;
import com.intiformation.projet.caveavin.modele.Champagne;
import com.intiformation.projet.caveavin.modele.Spiritueux;
import com.intiformation.projet.caveavin.modele.Vin;

public class AlcoolDAOImpl implements IAlcoolDAO {

	@Override
	public boolean add(Alcool pAlcool) {

		PreparedStatement ps1 = null;
		PreparedStatement ps2 = null;
		PreparedStatement ps3 = null;
		
		ResultSet rs2 = null;
		
		try {
			ps1 = this.connection.prepareStatement("INSERT INTO alcools (class_name, designation, description, prix, quantité, photo, annee) VALUES (?, ?, ?, ?, ?, ?, ?)");
			
			ps1.setString(1, pAlcool.getClass().getName());
			ps1.setString(2, pAlcool.getDesignation());
			ps1.setString(3, pAlcool.getDescription());
			ps1.setDouble(4, pAlcool.getPrix());
			ps1.setInt(5, pAlcool.getQuantite());
			ps1.setBytes(6, pAlcool.getPhoto());
			if (pAlcool instanceof Vin) {
				ps1.setInt(6, ((Vin)pAlcool).getAnnee());
			} else if (pAlcool instanceof Champagne) {
				ps1.setInt(6, ((Champagne)pAlcool).getAnnee());
			} else {
				ps1.setInt(6, 0);
			}
			
			
			ps1.executeUpdate();
			
			ps2 = this.connection.prepareStatement("SELECT MAX(id_alcool) FROM alcools");
			
			rs2 = ps2.executeQuery();
			
			rs2.next();
			
			int idAlcool = rs2.getInt(1);
			
			if (pAlcool instanceof Biere) {
				ps3 = this.connection.prepareStatement("INSERT INTO alcools_categories VALUES (?,?), (?,?)");
				
				ps3.setInt(1, idAlcool);
				ps3.setInt(2, ((Biere) pAlcool).getPays().getIdPays());
				ps3.setInt(3, idAlcool);
				ps3.setInt(4, ((Biere) pAlcool).getType().getIdType());
				
			} else if (pAlcool instanceof Spiritueux) {
				ps3 = this.connection.prepareStatement("INSERT INTO alcools_categories VALUES (?,?), (?,?)");
				
				ps3.setInt(1, idAlcool);
				ps3.setInt(2, ((Spiritueux) pAlcool).getPays().getIdPays());
				ps3.setInt(3, idAlcool);
				ps3.setInt(4, ((Spiritueux) pAlcool).getType().getIdType());
				
			} else if (pAlcool instanceof Vin) {
				ps3 = this.connection.prepareStatement("INSERT INTO alcools_categories VALUES (?,?), (?,?), (?,?), (?,?)");
				
				ps3.setInt(1, idAlcool);
				ps3.setInt(2, ((Vin) pAlcool).getPays().getIdPays());
				ps3.setInt(3, idAlcool);
				ps3.setInt(4, ((Vin) pAlcool).getRegion().getIdRegion());
				ps3.setInt(5, idAlcool);
				ps3.setInt(6, ((Vin) pAlcool).getType().getIdType());
				
			} else if (pAlcool instanceof Champagne) {
				ps3 = this.connection.prepareStatement("INSERT INTO alcools_categories VALUES (?,?), (?, ?)");
				
				ps3.setInt(1, idAlcool);
				ps3.setInt(2, ((Champagne) pAlcool).getType().getIdType());
				
			}
			
			int verifUpdate = ps3.executeUpdate();
			
			return (verifUpdate == 1);
			
			
			
		} catch (SQLException e) {
			System.out.println("... Erreur lors de l'ajout / méthode add() ...");
			e.printStackTrace();
			
		} finally {
			
			try {
				if (ps1 != null) {
					ps1.close();
				}
				
				if (ps2 != null) {
					ps2.close();
				}
				
				if (ps3 != null) {
					ps3.close();
				}
				
			} catch (SQLException e) {
				e.printStackTrace();
			}//end catch
			
		}//end finally
		
		return false;
	}//end add()

	@Override
	public boolean update(Alcool pAlcool) {

		PreparedStatement ps1 = null;
		PreparedStatement ps2 = null;
		PreparedStatement ps3 = null;
		
		ResultSet rs2 = null;
		
		try {
			ps1 = this.connection.prepareStatement("UPDATE alcools SET class_name=?, designation=?, description=?, prix=?, quantité=?, photo=?, annee=? WHERE id_alcool=?");
			
			int idAlcool = pAlcool.getIdAlcool();
			
			ps1.setString(1, pAlcool.getClass().getName());
			ps1.setString(2, pAlcool.getDesignation());
			ps1.setString(3, pAlcool.getDescription());
			ps1.setDouble(4, pAlcool.getPrix());
			ps1.setInt(5, pAlcool.getQuantite());
			ps1.setBytes(6, pAlcool.getPhoto());
			if (pAlcool instanceof Vin) {
				ps1.setInt(6, ((Vin) pAlcool).getAnnee());
			} else if (pAlcool instanceof Champagne) {
				ps1.setInt(6, ((Champagne) pAlcool).getAnnee());
			} else {
				ps1.setInt(6, 0);
			}
			ps1.setInt(1, idAlcool);
			
			ps1.executeUpdate();
			
			ps2 = this.connection.prepareStatement("DELETE FROM alcools_categories WHERE alcool_id=?");
			
			ps2.setInt(1, idAlcool);
			
			ps2.executeUpdate();
			
			if (pAlcool instanceof Biere) {
				ps3 = this.connection.prepareStatement("INSERT INTO alcools_categories VALUES (?,?), (?,?)");
				
				ps3.setInt(1, idAlcool);
				ps3.setInt(2, ((Biere) pAlcool).getPays().getIdPays());
				ps3.setInt(3, idAlcool);
				ps3.setInt(4, ((Biere) pAlcool).getType().getIdType());
				
			} else if (pAlcool instanceof Spiritueux) {
				ps3 = this.connection.prepareStatement("INSERT INTO alcools_categories VALUES (?,?), (?,?)");
				
				ps3.setInt(1, idAlcool);
				ps3.setInt(2, ((Spiritueux) pAlcool).getPays().getIdPays());
				ps3.setInt(3, idAlcool);
				ps3.setInt(4, ((Spiritueux) pAlcool).getType().getIdType());
				
			} else if (pAlcool instanceof Vin) {
				ps3 = this.connection.prepareStatement("INSERT INTO alcools_categories VALUES (?,?), (?,?), (?,?)");
				
				ps3.setInt(1, idAlcool);
				ps3.setInt(2, ((Vin) pAlcool).getPays().getIdPays());
				ps3.setInt(3, idAlcool);
				ps3.setInt(4, ((Vin) pAlcool).getRegion().getIdRegion());
				ps3.setInt(5, idAlcool);
				ps3.setInt(6, ((Vin) pAlcool).getType().getIdType());
				
			} else if (pAlcool instanceof Champagne) {
				ps3 = this.connection.prepareStatement("INSERT INTO alcools_categories VALUES (?,?)");
				
				ps3.setInt(1, idAlcool);
				ps3.setInt(2, ((Champagne) pAlcool).getType().getIdType());
				
			}
			
			int verifUpdate = ps3.executeUpdate();
			
			return (verifUpdate == 1);
			
			
			
		} catch (SQLException e) {
			System.out.println("... Erreur lors de la modification / méthode update() ...");
			e.printStackTrace();
			
		} finally {
			
			try {
				if (ps1 != null) {
					ps1.close();
				}
				
				if (ps2 != null) {
					ps2.close();
				}
				
				if (ps3 != null) {
					ps3.close();
				}
				
			} catch (SQLException e) {
				e.printStackTrace();
			}//end catch
			
		}//end finally
		
		return false;
	}//end update()

	@Override
	public boolean delete(Integer pIdAlcool) {

		PreparedStatement ps = null;
		
		try {
			
			ps = this.connection.prepareStatement("DELETE FROM alcools WHERE id_alcool=?");
			
			ps.setInt(1, pIdAlcool);
			
			int verifSuppr = ps.executeUpdate();
			
			return (verifSuppr == 1);
			
		} catch (SQLException e) {
			System.out.println("... Erreur lors de la suppression / méthode delete() ...");
			e.printStackTrace();
			
		} finally {
			
			try {
				
				if (ps != null) {
					ps.close();
				}
				
			} catch (SQLException e) {
				e.printStackTrace();
			}//end catch
			
		}//end finally block
		
		return false;
	}//end delete

	@Override
	public List<Alcool> getAll() {
		return null;
	}//end getAll()

	@Override
	public Alcool getById(Integer pIdAlcool) {
		
		PreparedStatement ps = null;
		ResultSet rs = null;
		
		try {
			
			ps = this.connection.prepareStatement("SELECT * FROM alcools WHERE id_alcool=?");
			
			ps.setInt(1, pIdAlcool);
			
			rs = ps.executeQuery();
			
			int id = rs.getInt(1);
			String nom = rs.getString(3);
			String description = rs.getString(4);
			int prix = rs.getInt(5);
			int quantite = rs.getInt(6);
			boolean selectionne = rs.getBoolean(7);
			byte[] photo = rs.getBytes(8);
			double promo = rs.getDouble(9);
			
			Alcool alcool = new Alcool(id, nom, description, prix, quantite, selectionne, photo, promo);

			PreparedStatement ps2 = null;
			ResultSet rs2 = null;
			PreparedStatement ps3 = null;
			ResultSet rs3 = null;
			PreparedStatement ps4 = null;
			ResultSet rs4 = null;
			
			if (alcool instanceof Biere) {
				
				ps2 = this.connection.prepareStatement("SELECT * FROM alcools_categories, categories WHERE alcool_id=? AND categorie_id=id_categorie AND class_name='CatPays'");
				ps2.setInt(1, pIdAlcool);
				CatPays pays = new CatPays(rs2.getInt(2), rs2.getString(5));
				
				ps3 = this.connection.prepareStatement("SELECT * FROM alcools_categories, categories WHERE alcool_id=? AND categorie_id=id_categorie AND class_name='CatTypes'");
				ps3.setInt(1, pIdAlcool);
				CatType type = new CatType(rs3.getInt(2), rs3.getString(5), rs3.getString(6));
				
				Biere biere = new Biere(id, nom, description, prix, quantite, selectionne, photo, promo, pays, type);
				
				return biere;
				
			} else if (alcool instanceof Spiritueux) {
				
				ps2 = this.connection.prepareStatement("SELECT * FROM alcools_categories, categories WHERE alcool_id=? AND categorie_id=id_categorie AND class_name='CatPays'");
				ps2.setInt(1, pIdAlcool);
				CatPays pays = new CatPays(rs2.getInt(2), rs2.getString(5));
				
				ps3 = this.connection.prepareStatement("SELECT * FROM alcools_categories, categories WHERE alcool_id=? AND categorie_id=id_categorie AND class_name='CatTypes'");
				ps3.setInt(1, pIdAlcool);
				CatType type = new CatType(rs3.getInt(2), rs3.getString(5), rs3.getString(6));
				
				Spiritueux spiritueux = new Spiritueux(id, nom, description, prix, quantite, selectionne, photo, promo, pays, type);
				
				return spiritueux;
				
			} else if (alcool instanceof Vin) {
				
				int annee = rs.getInt(10);
				
				ps2 = this.connection.prepareStatement("SELECT * FROM alcools_categories, categories WHERE alcool_id=? AND categorie_id=id_categorie AND class_name='CatPays'");
				ps2.setInt(1, pIdAlcool);
				CatPays pays = new CatPays(rs2.getInt(2), rs2.getString(5));
				
				ps3 = this.connection.prepareStatement("SELECT * FROM alcools_categories, categories WHERE alcool_id=? AND categorie_id=id_categorie AND class_name='CatTypes'");
				ps3.setInt(1, pIdAlcool);
				CatType type = new CatType(rs3.getInt(2), rs3.getString(5), rs3.getString(6));
				
				ps4 = this.connection.prepareStatement("SELECT * FROM alcools_categories, categories WHERE alcool_id=? AND categorie_id=id_categorie AND class_name='CatRegion'");
				ps4.setInt(1, pIdAlcool);
				CatRegion region = new CatRegion(rs4.getInt(2), rs4.getString(5));
				
				List<CatCepage> listeCepages = getAllCepageByAlcool(pIdAlcool);
				
				Vin vin = new Vin(id, nom, description, prix, quantite, selectionne, photo, promo, pays, region, type, listeCepages, annee);
				
			} else if (alcool instanceof Champagne) {
				
				int annee = rs.getInt(10);
				
				ps2 = this.connection.prepareStatement("SELECT * FROM alcools_categories, categories WHERE alcool_id=? AND categorie_id=id_categorie AND class_name='CatTypes'");
				ps2.setInt(1, pIdAlcool);
				CatType type = new CatType(rs2.getInt(2), rs2.getString(5), rs2.getString(6));
				
				List<CatCepage> listeCepages = getAllCepageByAlcool(pIdAlcool);
				
				Champagne champagne = new Champagne(id, nom, description, prix, quantite, selectionne, photo, promo, type, listeCepages, annee);
				
			}
			
		} catch (SQLException e) {
			
			System.out.println("... Erreur lors de la récupération par Id / méthode getById() ...");
			
			e.printStackTrace();
			
		} finally {
			
			try {
				
				if (rs != null) {
					rs.close();
				}
				
				if (ps != null) {
					ps.close();
				}
				
			} catch (Exception e) {
				e.printStackTrace();
			}//end catch
			
		}
		
		return null;
	}//end getById()

	@Override
	public Alcool getByNom(String pNomAlcool) {

		PreparedStatement ps = null;
		ResultSet rs = null;
		
		try {
			
			ps = this.connection.prepareStatement("SELECT * FROM alcools WHERE designation=?");
			
			ps.setString(1, pNomAlcool);
			
			rs = ps.executeQuery();
			
			int id = rs.getInt(1);
			String nom = rs.getString(3);
			String description = rs.getString(4);
			int prix = rs.getInt(5);
			int quantite = rs.getInt(6);
			boolean selectionne = rs.getBoolean(7);
			byte[] photo = rs.getBytes(8);
			double promo = rs.getDouble(9);
			
			Alcool alcool = new Alcool(id, nom, description, prix, quantite, selectionne, photo, promo);

			PreparedStatement ps2 = null;
			ResultSet rs2 = null;
			PreparedStatement ps3 = null;
			ResultSet rs3 = null;
			PreparedStatement ps4 = null;
			ResultSet rs4 = null;
			
			if (alcool instanceof Biere) {
				
				ps2 = this.connection.prepareStatement("SELECT * FROM alcools_categories, categories WHERE alcool_id=? AND categorie_id=id_categorie AND class_name='CatPays'");
				ps2.setInt(1, id);
				CatPays pays = new CatPays(rs2.getInt(2), rs2.getString(5));
				
				ps3 = this.connection.prepareStatement("SELECT * FROM alcools_categories, categories WHERE alcool_id=? AND categorie_id=id_categorie AND class_name='CatTypes'");
				ps3.setInt(1, id);
				CatType type = new CatType(rs3.getInt(2), rs3.getString(5), rs3.getString(6));
				
				Biere biere = new Biere(id, nom, description, prix, quantite, selectionne, photo, promo, pays, type);
				
				return biere;
				
			} else if (alcool instanceof Spiritueux) {
				
				ps2 = this.connection.prepareStatement("SELECT * FROM alcools_categories, categories WHERE alcool_id=? AND categorie_id=id_categorie AND class_name='CatPays'");
				ps2.setInt(1, id);
				CatPays pays = new CatPays(rs2.getInt(2), rs2.getString(5));
				
				ps3 = this.connection.prepareStatement("SELECT * FROM alcools_categories, categories WHERE alcool_id=? AND categorie_id=id_categorie AND class_name='CatTypes'");
				ps3.setInt(1, id);
				CatType type = new CatType(rs3.getInt(2), rs3.getString(5), rs3.getString(6));
				
				Spiritueux spiritueux = new Spiritueux(id, nom, description, prix, quantite, selectionne, photo, promo, pays, type);
				
				return spiritueux;
				
			} else if (alcool instanceof Vin) {
				
				int annee = rs.getInt(10);
				
				ps2 = this.connection.prepareStatement("SELECT * FROM alcools_categories, categories WHERE alcool_id=? AND categorie_id=id_categorie AND class_name='CatPays'");
				ps2.setInt(1, id);
				CatPays pays = new CatPays(rs2.getInt(2), rs2.getString(5));
				
				ps3 = this.connection.prepareStatement("SELECT * FROM alcools_categories, categories WHERE alcool_id=? AND categorie_id=id_categorie AND class_name='CatTypes'");
				ps3.setInt(1, id);
				CatType type = new CatType(rs3.getInt(2), rs3.getString(5), rs3.getString(6));
				
				ps4 = this.connection.prepareStatement("SELECT * FROM alcools_categories, categories WHERE alcool_id=? AND categorie_id=id_categorie AND class_name='CatRegion'");
				ps4.setInt(1, id);
				CatRegion region = new CatRegion(rs4.getInt(2), rs4.getString(5));
				
				List<CatCepage> listeCepages = getAllCepageByAlcool(id);
				
				Vin vin = new Vin(id, nom, description, prix, quantite, selectionne, photo, promo, pays, region, type, listeCepages, annee);
				
			} else if (alcool instanceof Champagne) {
				
				int annee = rs.getInt(10);
				
				ps2 = this.connection.prepareStatement("SELECT * FROM alcools_categories, categories WHERE alcool_id=? AND categorie_id=id_categorie AND class_name='CatTypes'");
				ps2.setInt(1, id);
				CatType type = new CatType(rs2.getInt(2), rs2.getString(5), rs2.getString(6));
				
				List<CatCepage> listeCepages = getAllCepageByAlcool(id);
				
				Champagne champagne = new Champagne(id, nom, description, prix, quantite, selectionne, photo, promo, type, listeCepages, annee);
				
			}
			
		} catch (SQLException e) {
			
			System.out.println("... Erreur lors de la récupération par nom / méthode getByNom() ...");
			
			e.printStackTrace();
			
		} finally {
			
			try {
				
				if (rs != null) {
					rs.close();
				}
				
				if (ps != null) {
					ps.close();
				}
				
			} catch (Exception e) {
				e.printStackTrace();
			}//end catch
			
		}
		
		return null;
	}//end getByNom()

	@Override
	public List<CatCepage> getAllCepageByAlcool(Integer pIdAlcool) {
		
		PreparedStatement ps = null;
		ResultSet rs = null;
		
		try {
			
			ps = this.connection.prepareStatement("SELECT * FROM alcools_categories, categories WHERE alcool_id=? AND categorie_id=id_categorie AND class_name='CatCepage'");
			
			ps.setInt(1, pIdAlcool);
			
			CatCepage cepage = null;
			List<CatCepage> listeCepages = new ArrayList<>();
			
			while (rs.next()) {
				
				cepage = new CatCepage(rs.getInt(2), rs.getString(5));
				
				listeCepages.add(cepage);
				
			}//end while
			
			
		} catch (SQLException e) {
			System.out.println("... Erreur lors de la récupération de la liste des cépages / méthode getAllCepageByAlcool() ...");
			
			e.printStackTrace();
		} finally {
			
		}
		
		return null;
	}//end getAllCepageByAlcool()

	@Override
	public boolean addCepageAlcool(Integer pIdAlcool, Integer pIdCepage) {
		return false;
	}//end addCepageAlcool()

	@Override
	public boolean deleteCepageAlcool(Integer pIdAlcool, Integer pIdCepage) {
		return false;
	}//end deleteCepageAlcool()


}//end class
